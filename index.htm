<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoAI æ–°ç”Ÿå…’æ€¥æ•‘å°å¹«æ‰‹ v4.1 </title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #0e2f5f;
            --secondary: #3a577b;
            --accent: #5188cc;
            --highlight: #ff6a00;
            --highlight-bg: #fff3e0;
            --bg: #f4f7f6;
            --white: #ffffff;
            --chat-bg: #eef1f5;
            --user-msg: #3a577b;
            --system-msg: #ffffff;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            overflow: hidden;
        }

        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            padding-bottom: 70px;
            position: relative;
        }

        .content-pad { padding: 20px; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }

        /* ============ Part 1: Flow Chart Styles (From v2.1) ============ */
        .flow-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .flow-btn {
            background: var(--white);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        .flow-btn.active {
            background: var(--secondary);
            color: var(--white);
            box-shadow: 0 2px 5px rgba(58, 87, 123, 0.3);
        }

        .flow-wrapper {
            position: relative;
            min-height: 400px;
        }

        .mermaid-container {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box;
            opacity: 1;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .mermaid-hidden {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            z-index: -1;
            pointer-events: none;
            visibility: hidden;
        }

        .mermaid {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .hint-text {
            text-align: center;
            color: var(--highlight);
            font-size: 0.85rem;
            margin-top: 10px;
            background-color: var(--highlight-bg);
            padding: 8px;
            border-radius: 8px;
            border: 1px dashed var(--highlight);
            margin-bottom: 15px;
        }

        /* ============ Part 2: Chatbot Styles ============ */
        .chat-layout { display: flex; flex-direction: column; height: 100%; background-color: var(--chat-bg); }
        .status-bar { background: white; padding: 10px 15px; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 40px; }
        .scenario-tag { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; position: relative; animation: slideIn 0.3s ease; }
        .msg-sys { align-self: flex-start; background-color: var(--system-msg); color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-sys::before { content: "ğŸ¤–"; position: absolute; left: -25px; top: 0; font-size: 1.2rem; }
        .msg-user { align-self: flex-end; background-color: var(--user-msg); color: white; border-bottom-right-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .options-area { background: white; padding: 15px; border-top: 1px solid #eee; }
        .option-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { padding: 12px; border: 1px solid var(--secondary); background: white; color: var(--secondary); border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-align: left; }
        .opt-btn:active { background: var(--secondary); color: white; }
        .game-over { color: #d32f2f; font-weight: bold; text-align: center; padding: 10px; background: #ffebee; border-radius: 8px; margin-top: 10px; }
        .game-success { color: #2e7d32; font-weight: bold; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 8px; margin-top: 10px; }

        /* ============ Part 3: Calculator Styles ============ */
        .calc-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; }
        .input-group { margin-bottom: 25px; text-align: center; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .input-group input { font-size: 1.5rem; padding: 10px; width: 140px; text-align: center; border: 2px solid var(--secondary); border-radius: 8px; color: var(--primary); outline: none; }
        .result-box { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--secondary); display: flex; justify-content: space-between; align-items: center; }
        .result-box.highlight { border-left-color: var(--highlight); background-color: #fff8e1; }
        .result-title { font-size: 0.95rem; color: #555; font-weight: bold; }
        .result-value { font-size: 1.3rem; color: var(--primary); font-weight: bold; }
        .result-value.highlight-text { color: #d84315; }

        /* ============ Part 4: Metronome Styles ============ */
        .metro-container { text-align: center; max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .visual-beat { display: flex; justify-content: center; gap: 15px; margin: 30px 0; }
        .beat-circle { width: 60px; height: 60px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; transition: all 0.1s; }
        .beat-circle.active { transform: scale(1.1); box-shadow: 0 0 15px var(--highlight); }
        .beat-1.active, .beat-2.active, .beat-3.active { background-color: var(--secondary); color: white; }
        .beat-breath.active { background-color: var(--highlight); color: white; }
        .metro-btn { background-color: var(--highlight); color: white; border: none; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 0 #bf360c; }
        .metro-btn.playing { background-color: #d32f2f; box-shadow: 0 4px 0 #b71c1c; }

        /* ============ Part 5: Apgar Styles ============ */
        .apgar-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; }
        .timer-display { font-size: 3.5rem; font-weight: bold; color: var(--primary); text-align: center; margin: 10px 0; font-variant-numeric: tabular-nums; }
        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .timer-btn { padding: 8px 25px; border-radius: 20px; font-size: 1rem; cursor: pointer; border: none; font-weight: bold; }
        .btn-start { background: #2e7d32; color: white; }
        .btn-reset { background: #d32f2f; color: white; }
        .apgar-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .apgar-row { border-bottom: 1px solid #eee; }
        .apgar-label { font-weight: bold; padding: 10px 0; color: var(--secondary); }
        .apgar-options { display: flex; gap: 5px; padding-bottom: 10px; }
        .apgar-opt { flex: 1; border: 1px solid #ccc; border-radius: 6px; padding: 8px 2px; text-align: center; cursor: pointer; font-size: 0.85rem; color: #666; transition: all 0.2s; }
        .apgar-opt.selected { background-color: var(--secondary); color: white; border-color: var(--secondary); }
        .score-display { text-align: center; margin-top: 15px; padding: 15px; background: #f0f4f8; border-radius: 10px; }
        .total-score { font-size: 2rem; font-weight: bold; color: var(--highlight); }
        .record-area { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        .record-btn { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .record-result { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #555; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #eee; }

        /* ============ Modal Styles (From v2.1) ============ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(14, 47, 95, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-card {
            background: white;
            width: 85%;
            max-width: 400px;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-top: 6px solid var(--highlight);
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .modal-body {
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-body ul { padding-left: 20px; margin: 5px 0; }
        .modal-body li { margin-bottom: 5px; }
        .modal-close {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ============ Navigation ============ */
        nav { position: fixed; bottom: 0; width: 100%; background-color: var(--white); display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 20; border-top: 1px solid #eee; }
        nav button { background: none; border: none; color: #999; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 20%; }
        nav button.active { color: var(--primary); font-weight: bold; }
        nav button span { font-size: 1.4rem; margin-bottom: 2px; }
    </style>
</head>
<body>

<header>NeoAI æ–°ç”Ÿå…’æ€¥æ•‘å°å¹«æ‰‹</header>

<main>
    <div id="tab1" class="tab-content active">
        <div class="content-pad">
            <div class="flow-nav">
                <button class="flow-btn active" onclick="switchFlow('flow1')">1. åˆå§‹è©•ä¼°&åˆå§‹æ­¥é©Ÿ</button>
                <button class="flow-btn" onclick="switchFlow('flow2')">2. å‘¼å¸é“è™•ç†</button>
                <button class="flow-btn" onclick="switchFlow('flow3')">3. èƒ¸éƒ¨æŒ‰å£“èˆ‡æ€¥æ•‘è—¥ç‰©</button>
            </div>
            
            <div class="hint-text">ğŸ’¡ é»æ“Šæµç¨‹åœ–ä¸­çš„æ–¹å¡Šï¼Œå¯æŸ¥çœ‹è©³ç´°æ“ä½œæ¸…å–®èˆ‡è—¥ç‰©åŠ‘é‡</div>

            <div class="flow-wrapper">
                <div id="flow1" class="mermaid-container">
                    <div class="mermaid">
                    %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#3a577b', 'primaryTextColor': '#fff', 'lineColor': '#0e2f5f' }}}%%
                    graph TD
                        classDef blueBox fill:#3a577b,stroke:#0e2f5f,color:white,rx:5,ry:5,stroke-width:2px;
                        classDef orangeBox fill:#fff,stroke:#ff6a00,color:#ff6a00,stroke-width:3px,stroke-dasharray: 5 5;
                        classDef decision fill:#5188cc,stroke:#0e2f5f,color:white,shape:diamond;
                        classDef warning fill:#ff6a00,stroke:#d84315,color:white,shape:diamond;
                        Start(ç”¢å‰è«®è©¢<br/>åœ˜éšŠç°¡å ±):::blueBox --> Birth((å‡ºç”Ÿ)):::decision
                        Birth -- è¶³æœˆ/å¼µåŠ›ä½³/æœ‰å“­? --> Routine(å¸¸è¦ç…§è­·<br/>èˆ‡æ¯åŒå®¤):::blueBox
                        Birth -- å¦ --> Initial(åˆå§‹æ­¥é©Ÿ A<br/>ä¿æš–/æ“ºä½/æŠ½å¸/åˆºæ¿€):::blueBox
                        Initial --> Check1{ç„¡å‘¼å¸/å–˜<br/>æˆ–<br/>HR < 100?}:::warning
                        Check1 -- å¦ --> BreathDiff{å‘¼å¸è²»åŠ›<br/>æˆ–ç™¼ç´º?}:::decision
                        BreathDiff -- æ˜¯ --> CPAP(CPAP æ°£é“æ­£å£“<br/>æ¥ä¸Š SpO2):::orangeBox
                        BreathDiff -- å¦ --> Routine
                        Check1 -- æ˜¯ --> PPV_Start(çµ¦äºˆ PPV æ­£å£“æ›æ°£<br/>æ¥ä¸Š SpO2 / ECG):::warning
                        click Start call showDetail("prenatal")
                        click Routine call showDetail("routine")
                        click Initial call showDetail("initial_steps")
                        click CPAP call showDetail("cpap")
                        click PPV_Start call showDetail("ppv_indication")
                    </div>
                </div>
                <div id="flow2" class="mermaid-container mermaid-hidden">
                    <div class="mermaid">
                    %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#3a577b', 'primaryTextColor': '#fff', 'lineColor': '#0e2f5f' }}}%%
                    graph TD
                        classDef blueBox fill:#3a577b,stroke:#0e2f5f,color:white,rx:5,ry:5,stroke-width:2px;
                        classDef orangeBox fill:#fff,stroke:#ff6a00,color:#ff6a00,stroke-width:3px;
                        classDef decision fill:#5188cc,stroke:#0e2f5f,color:white,shape:diamond;
                        classDef warning fill:#ff6a00,stroke:#d84315,color:white,shape:diamond;
                        PPV(PPV æ­£å£“æ›æ°£):::blueBox --> CheckEffect{15ç§’å¾Œè©•ä¼°<br/>å¿ƒè·³å‡? èƒ¸èµ·ä¼?}:::decision
                        CheckEffect -- å¦ --> MRSOPA(çŸ¯æ­£æ­¥é©Ÿ MR. SOPA):::orangeBox
                        MRSOPA --> Reassess(å†è©•ä¼°å¿ƒè·³èˆ‡èµ·ä¼):::decision
                        Reassess -- ä»ç„¡æ•ˆ --> Airway(å»ºç«‹é«˜ç´šå‘¼å¸é“<br/>LMA æˆ– æ’ç®¡):::blueBox
                        CheckEffect -- æœ‰æ•ˆ --> ContinuePPV(æŒçºŒæœ‰æ•ˆ PPV 30ç§’):::blueBox
                        Airway --> ContinuePPV
                        ContinuePPV --> HRCheck{å¿ƒè·³ < 100 ?}:::decision
                        HRCheck -- å¦ --> PostCare(å¾©ç”¦å¾Œç…§è­·):::blueBox
                        HRCheck -- æ˜¯ --> HR60Check{âš ï¸ å¿ƒè·³ < 60 ?}:::warning
                        HR60Check -- å¦ --> CheckTech(æª¢æŸ¥é€šæ°£/æ°§æ°£æ¿ƒåº¦):::blueBox
                        HR60Check -- æ˜¯ --> Compressions(é€²å…¥èƒ¸å¤–æŒ‰å£“éšæ®µ):::warning
                        click PPV call showDetail("ppv_tech")
                        click MRSOPA call showDetail("mrsopa")
                        click Airway call showDetail("airway_size")
                        click HR60Check call showDetail("hr_critical")
                    </div>
                </div>
                <div id="flow3" class="mermaid-container mermaid-hidden">
                    <div class="mermaid">
                    %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#3a577b', 'primaryTextColor': '#fff', 'lineColor': '#0e2f5f' }}}%%
                    graph TD
                        classDef blueBox fill:#3a577b,stroke:#0e2f5f,color:white,rx:5,ry:5,stroke-width:2px;
                        classDef orangeBox fill:#fff,stroke:#ff6a00,color:#ff6a00,stroke-width:3px;
                        classDef critical fill:#d84315,stroke:#333,color:white,rx:5,ry:5,stroke-width:2px,shadow:5px;
                        classDef warning fill:#ff6a00,stroke:#d84315,color:white,shape:diamond;
                        StartCPR(èƒ¸å¤–æŒ‰å£“ + PPV<br/>100% O2):::critical --> CPR60(æŒ‰å£“ 60 ç§’):::blueBox
                        CPR60 --> Reassess{å¿ƒè·³ä» < 60 ?}:::warning
                        Reassess -- å¦ --> StopCPR(åœæ­¢æŒ‰å£“<br/>æ¢å¾© PPV):::blueBox
                        Reassess -- æ˜¯ --> Epi(çµ¦äºˆ Epinephrine<br/>IV/IO å„ªå…ˆ):::critical
                        Epi --> EpiWait(ç¹¼çºŒæŒ‰å£“ + é€šæ°£):::blueBox
                        EpiWait --> Reassess2{å¿ƒè·³ä» < 60 ?}:::warning
                        Reassess2 -- å¦ --> StopCPR
                        Reassess2 -- æ˜¯ --> Causes(è€ƒæ…®ä½è¡€å®¹/æ°£èƒ¸):::orangeBox
                        Causes -- ä½è¡€å®¹ --> Volume(çµ¦äºˆè¼¸æ¶² N/S):::blueBox
                        Causes -- æ°£èƒ¸ --> Needle(é‡åˆºæ¸›å£“):::blueBox
                        click StartCPR call showDetail("cpr_tech")
                        click Epi call showDetail("epi_dose")
                        click Volume call showDetail("volume_dose")
                        click Causes call showDetail("shock_pneumo")
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab2" class="tab-content">
        <div class="chat-layout">
            <div class="status-bar">
                <span id="scenario-badge" class="scenario-tag">è«‹é¸æ“‡æƒ…å¢ƒ</span>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div class="options-area">
                <div id="option-grid" class="option-grid">
                    <button class="opt-btn" onclick="startScenario(1)">æƒ…å¢ƒä¸€ï¼š33é€± èƒç›¤å‰é›¢</button>
                    <button class="opt-btn" onclick="startScenario(2)">æƒ…å¢ƒäºŒï¼š38é€± èƒä¾¿å¸å…¥</button>
                    <button class="opt-btn" onclick="startScenario(3)">æƒ…å¢ƒä¸‰ï¼š36é€± æ³•æ´›æ°å››é‡ç—‡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <div class="content-pad">
            <div class="calc-card">
                <h3 style="text-align:center; color:var(--primary); margin-bottom:20px;">ç®¡è·¯èˆ‡è—¥ç‰©è©¦ç®—</h3>
                <div class="input-group">
                    <label>è¼¸å…¥é«”é‡ (kg)</label>
                    <input type="number" id="weightInput" placeholder="ex: 2.5" step="0.1" oninput="calculate()">
                </div>
                <div class="result-box"><div class="result-title">æ°£ç®¡å…§ç®¡å°ºå¯¸ (ET Tube ID)</div><div class="result-value" id="res-tube">-- mm</div></div>
                <div class="result-box"><div class="result-title">æ’ç®¡æ·±åº¦ (æ·±åº¦ depth)</div><div class="result-value" id="res-depth">-- cm</div></div>
                <div class="result-box"><div class="result-title">å–‰é ­é¡è‘‰ç‰‡ (Blade Size)</div><div class="result-value" id="res-blade">--</div></div>
                <div class="result-box highlight"><div class="result-title">Epinephrine æ€¥æ•‘åŠ‘é‡ (UVC/IO) <br><small>(1:10,000, 0.02 mg/kg)</small></div><div class="result-value highlight-text" id="res-epi-iv">-- ml</div></div>
                <div class="result-box highlight"><div class="result-title">Epinephrine æ€¥æ•‘åŠ‘é‡ (ET) <br><small>(1:10,000, 0.1 mg/kg)</small></div><div class="result-value highlight-text" id="res-epi-et">-- ml</div></div>
                <div class="result-box"><div class="result-title">å¤§é‡è¼¸æ¶² (N/S or Blood) <br><small>(10 ml/kg)</small></div><div class="result-value" id="res-fluid">-- ml</div></div>
            </div>
        </div>
    </div>

    <div id="tab4" class="tab-content">
        <div class="content-pad">
            <div class="metro-container">
                <h3 style="color:var(--primary);">CPR ç¯€æ‹å™¨ (3:1)</h3>
                <p style="color:#666;">æ¯ 2 ç§’å®Œæˆä¸€å¾ªç’°<br>(90æŒ‰å£“ : 30æ›æ°£ / åˆ†é˜)</p>
                <div class="visual-beat">
                    <div id="beat1" class="beat-circle beat-1">1</div>
                    <div id="beat2" class="beat-circle beat-2">2</div>
                    <div id="beat3" class="beat-circle beat-3">3</div>
                    <div id="beat4" class="beat-circle beat-breath">æ›æ°£</div>
                </div>
                <button id="metroBtn" class="metro-btn" onclick="toggleMetronome()">â–¶ é–‹å§‹</button>
            </div>
        </div>
    </div>

    <div id="tab5" class="tab-content">
        <div class="content-pad">
            <div class="apgar-card">
                <h3 style="text-align:center; color:var(--primary); margin:0;">Apgar Score Timer</h3>
                <div class="timer-display" id="apgarTimer">00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn btn-start" onclick="toggleApgarTimer()" id="apgarStartBtn">é–‹å§‹è¨ˆæ™‚</button>
                    <button class="timer-btn btn-reset" onclick="resetApgarTimer()">é‡ç½®</button>
                </div>
                <div id="apgar-calc"></div>
                <div class="score-display">ç¸½åˆ†ï¼š<span class="total-score" id="totalScore">0</span></div>
                <div class="record-area">
                    <button class="record-btn" onclick="recordScore(1)">ğŸ“¥ å­˜å…¥ 1åˆ†é˜</button>
                    <button class="record-btn" onclick="recordScore(5)">ğŸ“¥ å­˜å…¥ 5åˆ†é˜</button>
                </div>
                <div class="record-result">
                    <span>1 min: <strong id="rec-1min">--</strong></span>
                    <span>5 min: <strong id="rec-5min">--</strong></span>
                </div>
            </div>
        </div>
    </div>

</main>

<div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-card">
        <div class="modal-title" id="m-title">æ¨™é¡Œ</div>
        <div class="modal-body" id="m-body">å…§å®¹</div>
        <button class="modal-close" onclick="document.getElementById('detailModal').style.display='none'">é—œé–‰</button>
    </div>
</div>

<nav>
    <button onclick="switchTab('tab1')" id="btn-tab1" class="active"><span>ğŸ“Š</span>æµç¨‹åœ–</button>
    <button onclick="switchTab('tab2')" id="btn-tab2"><span>ğŸ’¬</span>æ¼”ç·´</button>
    <button onclick="switchTab('tab3')" id="btn-tab3"><span>ğŸ§®</span>è¨ˆç®—</button>
    <button onclick="switchTab('tab4')" id="btn-tab4"><span>âš¡</span>CPR</button>
    <button onclick="switchTab('tab5')" id="btn-tab5"><span>ğŸ‘¶</span>Apgar</button>
</nav>

<script>
    // Initialize Mermaid
    mermaid.initialize({ startOnLoad: true, securityLevel: 'loose', theme: 'base' });

    // ============ Part 1 Logic (Modal Data updated with v3 content) ============
    const detailContent = {
        prenatal: { title: "ç”¢å‰è«®è©¢ (4å€‹å•é¡Œ)", body: "<ul><li><strong>é ç”¢æœŸé€±æ•¸ï¼Ÿ</strong> (æ±ºå®šè¨­å‚™å°ºå¯¸)</li><li><strong>ç¾Šæ°´æ¸…æ¾ˆå—ï¼Ÿ</strong> (èƒä¾¿?)</li><li><strong>é æœŸé¢¨éšªå› å­ï¼Ÿ</strong> (å¦Šå¨ é«˜è¡€å£“ã€å¤šèƒèƒ?)</li><li><strong>è‡å¸¶è™•ç½®è¨ˆç•«ï¼Ÿ</strong> (æ˜¯å¦å»¶é²æ–·è‡?)</li></ul>" },
        routine: { title: "å¸¸è¦ç…§è­·", body: "<ul><li>èˆ‡æ¯è¦ªè‚Œè†šæ¥è§¸ (Skin-to-skin)</li><li>è“‹ä¸Šæº«æš–ä¹¾æ¯›å·¾</li><li>æŒçºŒè©•ä¼°å‘¼å¸ã€å¼µåŠ›ã€è†šè‰²</li></ul>" },
        initial_steps: { title: "åˆå§‹æ­¥é©Ÿ (Initial Steps)", body: "<ul><li><strong>ä¿æš–ï¼š</strong>ç¶­æŒé«”æº« 36.5-37.5Â°C</li><li><strong>æ“ºä½ï¼š</strong>å—…å¸å§¿å‹¢ (Sniffing position)</li><li><strong>æŠ½å¸ï¼š</strong>å…ˆå£å¾Œé¼» (M before N)ï¼Œåƒ…åœ¨æœ‰é˜»å¡æ™‚åŸ·è¡Œ</li><li><strong>æ“¦ä¹¾ï¼š</strong>ç§»é™¤æ¿•æ¯›å·¾</li><li><strong>åˆºæ¿€ï¼š</strong>æ‘©æ“¦èƒŒéƒ¨æˆ–è¼•å½ˆè…³åº•</li></ul>" },
        cpap: { title: "CPAP ä½¿ç”¨æŒ‡å¼•", body: "<ul><li><strong>é©æ‡‰ç—‡ï¼š</strong>æœ‰è‡ªä¸»å‘¼å¸ä½†å‘¼å¸è²»åŠ›ï¼Œæˆ–æŒçºŒç™¼ç´º</li><li><strong>å£“åŠ›è¨­å®šï¼š</strong>è‡³å°‘ 5 cmH2O</li><li><strong>ç›£æ¸¬ï¼š</strong>å¿…é ˆæ¥ä¸Š SpO2</li></ul>" },
        ppv_indication: { title: "PPV é©æ‡‰ç—‡", body: "<ul><li>ç„¡å‘¼å¸ (Apnea) æˆ– å–˜æ¯ (Gasping)</li><li>å¿ƒè·³ < 100 bpm</li><li><strong>é‡è¦ï¼š</strong>çµ¦äºˆ PPV æ™‚æ‡‰è¨­ç½® ECG å°ç¨‹ä»¥æº–ç¢ºç›£æ¸¬å¿ƒè·³</li></ul>" },
        ppv_tech: { title: "æ­£å£“æ›æ°£ (PPV) æŠ€å·§", body: "<ul><li><strong>é »ç‡ï¼š</strong>æ¯åˆ†é˜ 40-60 æ¬¡</li><li><strong>å£è¨£ï¼š</strong>å¹-äºŒ-ä¸‰ (Breath-Two-Three)</li><li><strong>å£“åŠ›ï¼š</strong>åˆå§‹ PIP 20-25 cmH2O (è¶³æœˆ)ï¼ŒPEEP 5 cmH2O</li></ul>" },
        mrsopa: { title: "MR. SOPA çŸ¯æ­£æ­¥é©Ÿ", body: "<ul><li><strong>M (Mask)ï¼š</strong>èª¿æ•´é¢ç½©å¯†åˆåº¦</li><li><strong>R (Reposition)ï¼š</strong>é‡æ–°æ“ºä½æ°£é“</li><li><strong>S (Suction)ï¼š</strong>æŠ½å¸å£é¼»</li><li><strong>O (Open mouth)ï¼š</strong>å¼µé–‹å˜´å·´</li><li><strong>P (Pressure)ï¼š</strong>å¢åŠ å£“åŠ› (æ¯æ¬¡åŠ  5-10, max 40)</li><li><strong>A (Airway)ï¼š</strong>è€ƒæ…®äººå·¥æ°£é“ (æ’ç®¡/LMA)</li></ul>" },
        airway_size: { title: "æ°£ç®¡å…§ç®¡å°ºå¯¸å»ºè­°", body: "<ul><li>< 1000g / < 28w : <strong>2.5è™Ÿæ°£ç®¡å…§ç®¡</strong></li><li>1000-2000g / 28-34w : <strong>3è™Ÿæ°£ç®¡å…§ç®¡</strong></li><li>> 2000g / > 34w : <strong>3.5è™Ÿæ°£ç®¡å…§ç®¡</strong></li><li>æ·±åº¦ä¼°ç®—ï¼šé«”é‡(kg) + 6 cm</li></ul>" },
        hr_critical: { title: "é—œéµæ±ºç­–é»", body: "<strong style='color:red'>å¿ƒè·³ < 60 bpmï¼Ÿ</strong><br>é€™è¡¨ç¤ºå¿ƒè¼¸å‡ºé‡ä¸è¶³ã€‚<br>å¦‚æœå·²å®Œæˆæœ‰æ•ˆé€šæ°£ 30 ç§’å¿ƒè·³ä»ä½ï¼Œå¿…é ˆé–‹å§‹å£“èƒ¸ã€‚" },
        cpr_tech: { title: "èƒ¸å¤–æŒ‰å£“æŠ€å·§", body: "<ul><li><strong>ä½ç½®ï¼š</strong>å…©ä¹³é ­é€£ç·šä¸‹æ–¹èƒ¸éª¨è™•</li><li><strong>æ·±åº¦ï¼š</strong>èƒ¸å»“å‰å¾Œå¾‘ 1/3</li><li><strong>æ–¹æ³•ï¼š</strong>é›™æ‹‡æŒ‡ç’°æŠ±æ³• (å…©äººæ“ä½œ)</li><li><strong>æ¯”ä¾‹ï¼š</strong>3:1 (90æ¬¡æŒ‰å£“ : 30æ¬¡é€šæ°£)</li><li><strong>æ°§æ°£ï¼š</strong>èª¿è‡³ 100%</li></ul>" },
        epi_dose: { title: "Epinephrine è…ä¸Šè…ºç´ ", body: "<ul><li><strong>æ¿ƒåº¦ï¼š</strong>1:10,000 (0.1 mg/mL)</li><li><strong>IV/IO åŠ‘é‡ (é¦–é¸)ï¼š</strong>0.02 mg/kg (0.2 mL/kg)<br><span style='color:red'>â†’ çµ¦è—¥å¾Œ Flush N/S 3ml</span></li><li><strong>ET åŠ‘é‡ (æ°£ç®¡å…§)ï¼š</strong>0.1 mg/kg (1 mL/kg)<br><span style='color:red'>â†’ çµ¦è—¥å¾Œ Ambu-bagging (PPV)</span></li></ul>" },
        volume_dose: { title: "æ“´å®¹åŠ‘ (Volume Expander)", body: "<ul><li><strong>é©æ‡‰ç—‡ï¼š</strong>æœ‰ä¼‘å…‹å¾µè±¡ (è†šè‰²è’¼ç™½ã€è„ˆæå¾®å¼±) æˆ–æ›¾æœ‰å¤§é‡å¤±è¡€</li><li><strong>ç¨®é¡ï¼š</strong>Normal Saline æˆ– Oå‹ Rhé™°æ€§è¡€</li><li><strong>åŠ‘é‡ï¼š</strong>10 mL/kg</li><li><strong>é€Ÿåº¦ï¼š</strong>5-10 åˆ†é˜å…§çµ¦äºˆ</li></ul>" },
        shock_pneumo: { title: "æŒçºŒå¿ƒè·³éä½åŸå› ", body: "<ul><li><strong>ä½è¡€å®¹ï¼š</strong>çµ¦äºˆè¼¸æ¶²</li><li><strong>æ°£èƒ¸ï¼š</strong>è½è¨ºå‘¼å¸éŸ³ï¼Œé€å…‰æ¸¬è©¦ï¼Œé‡åˆºæ¸›å£“</li><li><strong>ç®¡è·¯æ»‘è„«/é˜»å¡ï¼š</strong>é‡æ–°æª¢æŸ¥ DOPE</li></ul>" }
    };

    window.showDetail = function(key) {
        const data = detailContent[key];
        if(data) {
            document.getElementById('m-title').innerHTML = data.title;
            document.getElementById('m-body').innerHTML = data.body;
            document.getElementById('detailModal').style.display = 'flex';
        }
    };

    window.closeModal = function(e) {
        if(e.target.className === 'modal-overlay') {
            document.getElementById('detailModal').style.display = 'none';
        }
    }

    function switchFlow(flowId) {
        document.querySelectorAll('.mermaid-container').forEach(el => el.classList.add('mermaid-hidden'));
        document.getElementById(flowId).classList.remove('mermaid-hidden');
        document.querySelectorAll('.flow-btn').forEach(el => el.classList.remove('active'));
        if(flowId === 'flow1') document.querySelectorAll('.flow-btn')[0].classList.add('active');
        if(flowId === 'flow2') document.querySelectorAll('.flow-btn')[1].classList.add('active');
        if(flowId === 'flow3') document.querySelectorAll('.flow-btn')[2].classList.add('active');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    // ============ Part 2 Logic: Chatbot (Team Member Update) ============
    let currentScenarioId = 0;
    const chatBox = document.getElementById('chat-box');
    const optGrid = document.getElementById('option-grid');
    const badge = document.getElementById('scenario-badge');

    const stories = {
        1: {
            title: "æƒ…å¢ƒä¸€ï¼š33é€±æ—©ç”¢ (èƒç›¤å‰é›¢)",
            startNode: 's1_start',
            nodes: {
                's1_start': { msg: "ã€ç”¢æˆ¿é€šå ±ã€‘<br>33é€±ç”¢å©¦ï¼Œèƒå…’é ä¼° 1800gmã€‚<br>å› èƒç›¤æ—©æœŸå‰é›¢ (Abruption) éœ€ç·Šæ€¥å‰–è…¹ã€‚<br>ç¾Šæ°´ï¼šè¡€æ€§ (Bloody)ã€‚<br>ç„¡å»¶é²æ–·è‡è¨ˆç•«ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè«‹é¸æ“‡å™¨ææº–å‚™ã€‚", options: [{ text: "æº–å‚™ 3.0 è™Ÿæ°£ç®¡å…§ç®¡, Blade 0è™Ÿ", next: 's1_birth', correct: true }, { text: "æº–å‚™ 2.5 è™Ÿæ°£ç®¡å…§ç®¡, Blade 00è™Ÿ", next: 's1_fail_tube', correct: false }, { text: "æº–å‚™ 3.5 è™Ÿæ°£ç®¡å…§ç®¡, Blade 1è™Ÿ", next: 's1_fail_tube', correct: false }] },
                's1_fail_tube': { msg: "âŒ éŒ¯èª¤é¸æ“‡ã€‚<br>1800gm (1-2kg) æ‡‰é¸æ“‡ 3.0 è™Ÿæ°£ç®¡å…§ç®¡ã€‚<br>å™¨ææº–å‚™ä¸ç•¶æœƒå»¶èª¤æ€¥æ•‘ã€‚", isFail: true },
                's1_birth': { msg: "ã€å¯¶å¯¶å‡ºç”Ÿã€‘<br>å…¨èº«ç™±è»Ÿ (Limp)ï¼Œæ²’æœ‰å‘¼å¸ï¼Œè†šè‰²è’¼ç™½ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "ç«‹åˆ»æ°£ç®¡æ’ç®¡", next: 's1_fail_intubate', correct: false }, { text: "è‡³è™•ç†å°ï¼šä¿æš–ã€æ“ºä½ã€æŠ½å¸å£é¼»ã€æ“¦ä¹¾åˆºæ¿€", next: 's1_initial', correct: true }] },
                's1_fail_intubate': { msg: "âŒ æµç¨‹éŒ¯èª¤ã€‚<br>é™¤éæ°£é“é˜»å¡ï¼Œå¦å‰‡æ‡‰å…ˆåŸ·è¡Œåˆå§‹æ­¥é©Ÿèˆ‡ PPVï¼Œä¸æ‡‰ç›´æ¥æ’ç®¡ã€‚", isFail: true },
                's1_initial': { msg: "ã€åˆå§‹æ­¥é©Ÿå¾Œã€‘<br>å¯¶å¯¶ä»ç„¡å‘¼å¸ (Apnea)ï¼Œå¿ƒè·³ 80 bpmã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œä¸‹ä¸€æ­¥ï¼Ÿ", options: [{ text: "çµ¦äºˆ 100% æ°§æ°£ (è‡ªç”±æµå‹•)", next: 's1_fail_o2', correct: false }, { text: "çµ¦äºˆ PPV (æ­£å£“æ›æ°£) + æ¥ä¸Š SpO2/ECG", next: 's1_ppv', correct: true }] },
                's1_fail_o2': { msg: "âŒ è™•ç½®ç„¡æ•ˆã€‚<br>Apnea (ç„¡å‘¼å¸) å¿…é ˆçµ¦äºˆ PPV æ‰èƒ½å»ºç«‹é€šæ°£ï¼Œå–®ç´”çµ¦æ°§æ°£ç„¡æ³•è§£æ±ºæ›æ°£å•é¡Œã€‚", isFail: true },
                's1_ppv': { msg: "ã€PPV é€²è¡Œä¸­ã€‘<br>ä½ é–‹å§‹åŸ·è¡Œ PPVã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè«‹é¸å‡ºæ­£ç¢ºçš„å£è¨£èˆ‡é »ç‡ã€‚", options: [{ text: "å¹-äºŒ-ä¸‰ (40-60æ¬¡/åˆ†)", next: 's1_mrsopa', correct: true }, { text: "å£“-åœ-å£“-åœ (100æ¬¡/åˆ†)", next: 's1_fail_rate', correct: false }] },
                's1_fail_rate': { msg: "âŒ é »ç‡éŒ¯èª¤ã€‚<br>é€™æ˜¯å£“èƒ¸çš„é »ç‡ï¼Œé€šæ°£é »ç‡æ‡‰ç‚º 40-60 æ¬¡/åˆ†ã€‚", isFail: true },
                's1_mrsopa': { msg: "ã€è©•ä¼°ã€‘<br>PPV 15ç§’å¾Œï¼Œå¿ƒè·³æ²’ä¸Šå‡ï¼Œèƒ¸å»“ç„¡èµ·ä¼ã€‚<br>ä½ åŸ·è¡Œ MR. SOPA çŸ¯æ­£å¾Œï¼Œçœ‹è¦‹èƒ¸å»“æœ‰èµ·ä¼äº†ã€‚<br>æŒçºŒæœ‰æ•ˆé€šæ°£30ç§’å¾Œï¼Œå¿ƒè·³æ‰åˆ° 50 bpmã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œä¸‹ä¸€æ­¥ï¼Ÿ", options: [{ text: "å¢åŠ  PPV å£“åŠ›", next: 's1_fail_pressure', correct: false }, { text: "é–‹å§‹å£“èƒ¸ (æ’ç®¡+100%æ°§æ°£)", next: 's1_cpr', correct: true }] },
                's1_fail_pressure': { msg: "âŒ æ±ºç­–éŒ¯èª¤ã€‚<br>èƒ¸å»“å·²æœ‰èµ·ä¼ä»£è¡¨é€šæ°£æˆåŠŸï¼Œè‹¥å¿ƒè·³ä» < 60ï¼Œæ‡‰é€²å…¥èƒ¸å¤–æŒ‰å£“éšæ®µã€‚", isFail: true },
                's1_cpr': { msg: "ã€æ€¥æ•‘è—¥ç‰©ã€‘<br>å£“èƒ¸èˆ‡é€šæ°£ (3:1) é€²è¡Œ60ç§’å¾Œï¼Œå¿ƒè·³ 40 bpmã€‚<br>éœ€çµ¦äºˆ Epinephrine (IV/IO)ã€‚<br>å¯¶å¯¶ 1.8 kgã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè«‹è¨ˆç®—åŠ‘é‡ (0.02 mg/kg, 1:10000)ã€‚", options: [{ text: "çµ¦äºˆ 0.36 ml + Flush N/S 3ml", next: 's1_volume', correct: true }, { text: "çµ¦äºˆ 1.8 ml + Flush N/S 3ml", next: 's1_fail_dose', correct: false }] },
                's1_fail_dose': { msg: "âŒ åŠ‘é‡éŒ¯èª¤ã€‚<br>1.8 ml æ˜¯æ°£ç®¡å…§ç®¡åŠ‘é‡ (0.1 mg/kg)ã€‚<br>éœè„ˆæ³¨å°„æ‡‰ç‚º 0.02 mg/kg (ç´„ 0.36 ml)ã€‚", isFail: true },
                's1_volume': { msg: "ã€æœ€çµ‚åˆ¤æ–·ã€‘<br>çµ¦è—¥å¾Œå¿ƒè·³å¾®å‡è‡³ 58 bpmï¼Œè†šè‰²æ¥µåº¦è’¼ç™½ã€‚<br>è€ƒæ…®èƒç›¤å‰é›¢ç—…å²ï¼Œæ‡·ç–‘ä½è¡€å®¹ä¼‘å…‹ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "çµ¦äºˆ N/S 18 ml (æ“´å®¹)", next: 's1_success', correct: true }, { text: "å†çµ¦ä¸€åŠ‘ Epinephrine", next: 's1_fail_shock', correct: false }] },
                's1_fail_shock': { msg: "âŒ åˆ¤æ–·å¤±èª¤ã€‚<br>æœ‰å¤§é‡å¤±è¡€ç—…å²ä¸”è†šè‰²è’¼ç™½ï¼Œæ‡‰å„ªå…ˆçŸ¯æ­£ä½è¡€å®¹ã€‚", isFail: true },
                's1_success': { msg: "ğŸ‰ æ­å–œï¼<br>çµ¦äºˆè¼¸æ¶²å¾Œï¼Œå¯¶å¯¶å¿ƒè·³å›å‡è‡³ 130 bpmï¼Œè†šè‰²è½‰ç´…ã€‚<br>è½‰é€ NICU è§€å¯Ÿã€‚", isSuccess: true }
            }
        },
        2: {
            title: "æƒ…å¢ƒäºŒï¼š38é€±è¶³æœˆ (èƒä¾¿å¸å…¥)",
            startNode: 's2_start',
            nodes: {
                's2_start': { msg: "ã€ç”¢æˆ¿é€šå ±ã€‘<br>38é€±ï¼Œé ä¼° 3000gmã€‚<br>èƒå¿ƒéŸ³ä¸‹é™ï¼Œç¾Šæ°´æœ‰èƒä¾¿ (MSAF)ã€‚<br>æ¯è¦ªæœ‰å¦Šå¨ é«˜è¡€å£“ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè«‹é¸æ“‡ç®¡è·¯èˆ‡å™¨æã€‚", options: [{ text: "3.5 è™Ÿæ°£ç®¡å…§ç®¡, Blade 1è™Ÿ", next: 's2_birth', correct: true }, { text: "3.0 è™Ÿæ°£ç®¡å…§ç®¡, Blade 0è™Ÿ", next: 's2_fail_size', correct: false }] },
                's2_fail_size': { msg: "âŒ å°ºå¯¸å¤ªå°ã€‚<br>3kg è¶³æœˆå…’æ‡‰ä½¿ç”¨ 3.5 è™Ÿæ°£ç®¡å…§ç®¡èˆ‡ 1 è™Ÿè‘‰ç‰‡ã€‚", isFail: true },
                's2_birth': { msg: "ã€å‡ºç”Ÿã€‘<br>å¯¶å¯¶å‡ºç”Ÿï¼Œæ´»åŠ›å·®ï¼Œä¸å“­ï¼Œå…¨èº«æ²¾æ»¿èƒä¾¿ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "ç«‹åˆ»æ’ç®¡æŠ½å¸èƒä¾¿", next: 's2_fail_suction', correct: false }, { text: "è‡³è™•ç†å°ï¼šä¿æš–ã€æ“ºä½ã€æŠ½å¸å£é¼» (å› é˜»å¡)", next: 's2_initial', correct: true }] },
                's2_fail_suction': { msg: "âŒ æŒ‡å¼•æ›´æ–°ã€‚<br>NRP ç›®å‰ä¸å†å»ºè­°å¸¸è¦æ’ç®¡æŠ½å¸èƒä¾¿ (å³ä¾¿æ˜¯æ´»åŠ›å·®çš„å¯¶å¯¶)ï¼Œé™¤éå‘¼å¸é“é˜»å¡ç„¡æ³•é€šæ°£ã€‚", isFail: true },
                's2_initial': { msg: "ã€è©•ä¼°ã€‘<br>æŠ½å¸å£é¼»å¾Œï¼Œå¯¶å¯¶ä»ç„¡å‘¼å¸ (Apnea)ï¼Œå¿ƒè·³ 90 bpmã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œä¸‹ä¸€æ­¥ï¼Ÿ", options: [{ text: "çµ¦äºˆ PPV æ­£å£“æ›æ°£", next: 's2_ppv', correct: true }, { text: "ç¹¼çºŒåˆºæ¿€", next: 's2_fail_stim', correct: false }] },
                's2_fail_stim': { msg: "âŒ å»¶èª¤æ²»ç™‚ã€‚<br>ç„¡å‘¼å¸ä¸”å¿ƒè·³ < 100ï¼Œæ‡‰ç«‹å³é–‹å§‹ PPVã€‚", isFail: true },
                's2_ppv': { msg: "ã€é€šæ°£ã€‘<br>PPV 15ç§’å¾Œï¼Œå¿ƒè·³ä¸Šå‡è‡³ 110 bpmï¼Œé–‹å§‹æœ‰è‡ªç™¼æ€§å‘¼å¸ã€‚<br>ä½†åœ¨æ‹”ç®¡æº–å‚™å¸¸è¦ç…§è­·æ™‚ï¼Œç™¼ç¾å¯¶å¯¶å‘¼å¸è²»åŠ›ä¸”ç™¼ç´ºã€‚<br>SpO2 80% (ç›®æ¨™ 90%)ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "ä½¿ç”¨ CPAP + SpO2 ç›£æ¸¬", next: 's2_success', correct: true }, { text: "å†æ¬¡æ’ç®¡", next: 's2_fail_aggressive', correct: false }] },
                's2_fail_aggressive': { msg: "âŒ éåº¦è™•ç½®ã€‚<br>å¿ƒè·³ > 100 ä¸”æœ‰è‡ªç™¼å‘¼å¸ï¼Œä½†è²»åŠ›ï¼Œæ‡‰å…ˆå˜—è©¦ CPAPã€‚", isFail: true },
                's2_success': { msg: "ğŸ‰ æ­å–œï¼<br>å¯¶å¯¶åœ¨ CPAP æ”¯æŒä¸‹å‘¼å¸æ”¹å–„ï¼ŒSpO2 ç©©å®šã€‚<br>æ€¥æ•‘æˆåŠŸã€‚", isSuccess: true }
            }
        },
        3: {
            title: "æƒ…å¢ƒä¸‰ï¼š36é€± (TOF)",
            startNode: 's3_start',
            nodes: {
                's3_start': { msg: "ã€ç”¢æˆ¿é€šå ±ã€‘<br>36é€±ï¼Œé ä¼° 2700gmã€‚<br>ç”¢å‰è¨ºæ–·ï¼šæ³•æ´›æ°å››é‡ç—‡ (TOF)ã€‚<br>ç¾Šæ°´ä¹¾æ·¨ã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè«‹é å‚™å™¨æé‡é»ã€‚", options: [{ text: "æº–å‚™ SpO2 æ¢é ­æ¥å³æ‰‹ (å°ç®¡å‰)", next: 's3_birth', correct: true }, { text: "æº–å‚™ 100% æ°§æ°£é é˜²ç™¼ç´º", next: 's3_fail_o2prep', correct: false }] },
                's3_fail_o2prep': { msg: "âŒ è§€å¿µéŒ¯èª¤ã€‚<br>TOF å¯¶å¯¶æœªå¿…éœ€è¦é«˜æ¿ƒåº¦æ°§æ°£ï¼Œéå¤šæ°§æ°£å¯èƒ½å°è‡´å‹•è„ˆå°ç®¡é—œé–‰ã€‚SpO2 ç›£æ¸¬æ‰æ˜¯é‡é»ã€‚", isFail: true },
                's3_birth': { msg: "ã€å‡ºç”Ÿã€‘<br>å¯¶å¯¶å‡ºç”Ÿï¼Œæœ‰å“­è²ï¼Œè‚Œå¼µåŠ›å°šå¯ã€‚<br>ä½†åœ¨å¸¸è¦ç…§è­·æ™‚ç™¼ç¾å…¨èº«ç™¼ç´ºã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "ç«‹åˆ»çµ¦äºˆ PPV", next: 's3_fail_ppv', correct: false }, { text: "æ¥ä¸Š SpO2 (å³æ‰‹) ç›£æ¸¬è¡€æ°§", next: 's3_assess', correct: true }] },
                's3_fail_ppv': { msg: "âŒ è™•ç½®éŒ¯èª¤ã€‚<br>å¯¶å¯¶æœ‰å“­è²ä¸”å‘¼å¸é †æš¢ï¼Œä¸éœ€è¦ PPVã€‚ç™¼ç´ºéœ€å…ˆç”±æ•¸å€¼åˆ¤æ–·ã€‚", isFail: true },
                's3_assess': { msg: "ã€ç›£æ¸¬ã€‘<br>å‡ºç”Ÿ 2 åˆ†é˜ï¼ŒSpO2 é¡¯ç¤º 60% (ç›®æ¨™ 65-70%)ã€‚<br>å¯¶å¯¶å‘¼å¸å¹³é †ï¼Œå¿ƒè·³ 140 bpmã€‚<br>ä½ æ˜¯æ€¥æ•‘åœ˜éšŠæˆå“¡ï¼Œè™•ç½®ï¼Ÿ", options: [{ text: "è§€å¯Ÿå³å¯", next: 's3_fail_watch', correct: false }, { text: "èª¿æ•´ FiO2 (çµ¦äºˆæ°§æ°£) å˜—è©¦é”æ¨™", next: 's3_success', correct: true }] },
                's3_fail_watch': { msg: "âŒ åˆ¤æ–·éŒ¯èª¤ã€‚<br>é›–ç„¶æ˜¯ TOFï¼Œä½† 60% ä½æ–¼ç›®æ¨™å€¼ (65%)ï¼Œä»æ‡‰çµ¦äºˆé©åº¦æ°§æ°£æ”¯æŒã€‚", isFail: true },
                's3_success': { msg: "ğŸ‰ æ­å–œï¼<br>çµ¦äºˆæ°§æ°£å¾Œ SpO2 ç¶­æŒåœ¨ 75-80% å®‰å…¨ç¯„åœã€‚<br>å¯¶å¯¶ç”Ÿå‘½å¾µè±¡ç©©å®šï¼Œè½‰é€ NICU é€²è¡Œå¿ƒè‡Ÿè©•ä¼°ã€‚", isSuccess: true }
            }
        }
    };

    function startScenario(id) {
        currentScenarioId = id;
        updateStatus(stories[id].title);
        chatBox.innerHTML = ''; renderNode(stories[id].startNode);
    }
    function renderNode(nodeId) {
        const scenario = stories[currentScenarioId];
        const node = scenario.nodes[nodeId];
        const sysDiv = document.createElement('div'); sysDiv.className = 'msg msg-sys'; sysDiv.innerHTML = node.msg; chatBox.appendChild(sysDiv); scrollToBottom();
        optGrid.innerHTML = '';
        if (node.isFail) { chatBox.innerHTML += `<div class="game-over">ä»»å‹™å¤±æ•—ï¼šè«‹é‡æ–°æŒ‘æˆ°</div>`; optGrid.innerHTML = `<button class="opt-btn" onclick="startScenario(${currentScenarioId})">ğŸ”„ é‡æ–°é–‹å§‹</button><button class="opt-btn" onclick="resetGame()">ğŸ  å›ä¸»é¸å–®</button>`; return; }
        if (node.isSuccess) { chatBox.innerHTML += `<div class="game-success">ä»»å‹™å®Œæˆï¼</div>`; optGrid.innerHTML = `<button class="opt-btn" onclick="resetGame()">ğŸ  å›ä¸»é¸å–®</button>`; return; }
        node.options.forEach(opt => { const btn = document.createElement('button'); btn.className = 'opt-btn'; btn.innerText = opt.text; btn.onclick = () => handleChoice(opt); optGrid.appendChild(btn); });
    }
    function handleChoice(option) {
        const userDiv = document.createElement('div'); userDiv.className = 'msg msg-user'; userDiv.innerText = option.text; chatBox.appendChild(userDiv); scrollToBottom();
        setTimeout(() => { renderNode(option.next); }, 500);
    }
    function resetGame() {
        chatBox.innerHTML = '';
        optGrid.innerHTML = `<button class="opt-btn" onclick="startScenario(1)">æƒ…å¢ƒä¸€ï¼š33é€± èƒç›¤å‰é›¢</button><button class="opt-btn" onclick="startScenario(2)">æƒ…å¢ƒäºŒï¼š38é€± èƒä¾¿å¸å…¥</button><button class="opt-btn" onclick="startScenario(3)">æƒ…å¢ƒä¸‰ï¼š36é€± æ³•æ´›æ°å››é‡ç—‡</button>`;
        badge.innerText = "è«‹é¸æ“‡æƒ…å¢ƒ"; badge.style.backgroundColor = "var(--primary)";
    }
    function updateStatus(title) { if(title) { badge.innerText = title; badge.style.backgroundColor = "var(--highlight)"; } }
    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

    // ============ Part 3 Logic: Calculator ============
    function calculate() {
        const wt = parseFloat(document.getElementById('weightInput').value);
        if (!wt || wt <= 0) { document.querySelectorAll('.result-value').forEach(el => el.innerText = "--"); return; }
        let size = "3.5"; if (wt < 1.0) size = "2.5"; else if (wt < 2.0) size = "3.0";
        document.getElementById('res-tube').innerText = size + " mm";
        document.getElementById('res-depth').innerText = (6 + wt).toFixed(1) + " cm";
        document.getElementById('res-blade').innerText = (wt < 2.5) ? "No. 0 (æ—©ç”¢å…’)" : "No. 1 (è¶³æœˆå…’)";
        document.getElementById('res-epi-iv').innerText = (0.2 * wt).toFixed(2) + " ml";
        document.getElementById('res-epi-et').innerText = (1.0 * wt).toFixed(1) + " ml";
        document.getElementById('res-fluid').innerText = (10 * wt).toFixed(0) + " ml";
    }

    // ============ Part 4 Logic: Metronome ============
    let audioCtx; let metroInterval; let isPlaying = false; let beatCount = 0;
    function playTone(freq, duration, type) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }
    function toggleMetronome() {
        const btn = document.getElementById('metroBtn');
        if (isPlaying) { clearInterval(metroInterval); isPlaying = false; btn.innerText = "â–¶ é–‹å§‹"; btn.classList.remove('playing'); resetVisuals(); }
        else {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = true; btn.innerText = "â–  åœæ­¢"; btn.classList.add('playing'); beatCount = 0; runBeat(); metroInterval = setInterval(runBeat, 500);
        }
    }
    function runBeat() {
        resetVisuals();
        if (beatCount < 3) { playTone(600, 0.1, 'sine'); document.getElementById('beat' + (beatCount + 1)).classList.add('active'); }
        else { playTone(400, 0.3, 'triangle'); document.getElementById('beat4').classList.add('active'); }
        beatCount++; if (beatCount > 3) beatCount = 0;
    }
    function resetVisuals() { document.querySelectorAll('.beat-circle').forEach(el => el.classList.remove('active')); }

    // ============ Part 5 Logic: Apgar Timer & Calc ============
    let apgarInterval; let apgarSeconds = 0; let apgarRunning = false;
    function toggleApgarTimer() {
        const btn = document.getElementById('apgarStartBtn');
        if(apgarRunning) { clearInterval(apgarInterval); apgarRunning = false; btn.innerText = "ç¹¼çºŒè¨ˆæ™‚"; btn.style.background = "#2e7d32"; } 
        else { apgarInterval = setInterval(apgarTick, 1000); apgarRunning = true; btn.innerText = "æš«åœ"; btn.style.background = "#f57c00"; }
    }
    function resetApgarTimer() {
        clearInterval(apgarInterval); apgarRunning = false; apgarSeconds = 0;
        document.getElementById('apgarTimer').innerText = "00:00";
        document.getElementById('apgarStartBtn').innerText = "é–‹å§‹è¨ˆæ™‚";
        document.getElementById('apgarStartBtn').style.background = "#2e7d32";
    }
    function apgarTick() {
        apgarSeconds++;
        const mins = Math.floor(apgarSeconds / 60).toString().padStart(2, '0');
        const secs = (apgarSeconds % 60).toString().padStart(2, '0');
        document.getElementById('apgarTimer').innerText = `${mins}:${secs}`;
        if(apgarSeconds === 60) speak('ä¸€åˆ†é˜');
        if(apgarSeconds === 300) speak('äº”åˆ†é˜');
    }
    function speak(text) {
        if('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            const voices = window.speechSynthesis.getVoices();
            const female = voices.find(v => v.lang === 'zh-TW' && (v.name.includes('Female') || v.name.includes('Mei')));
            if(female) utter.voice = female;
            window.speechSynthesis.speak(utter);
        }
    }
    // Apgar Data
    const apgarData = [
        { id: 'app', label: 'Appearance (è†šè‰²)', opts: ['0: å…¨èº«ç™¼ç´º/è’¼ç™½', '1: èº«é«”ç´…/å››è‚¢ç´º', '2: å…¨èº«ç´…æ½¤'] },
        { id: 'pul', label: 'Pulse (å¿ƒè·³)', opts: ['0: ç„¡å¿ƒè·³', '1: < 100 bpm', '2: > 100 bpm'] },
        { id: 'gri', label: 'Grimace (çšºçœ‰/åå°„)', opts: ['0: ç„¡åæ‡‰', '1: çšºçœ‰/å“­è²å¼±', '2: å“­/æ‰“å™´åš/é€€ç¸®'] },
        { id: 'act', label: 'Activity (è‚Œå¼µåŠ›)', opts: ['0: ç™±è»Ÿ', '1: å››è‚¢å¾®å½', '2: å‹•ä½œæ´»èº'] },
        { id: 'res', label: 'Respiration (å‘¼å¸)', opts: ['0: ç„¡å‘¼å¸', '1: æ…¢/ä¸è¦å‰‡', '2: å“­è²å®äº®'] }
    ];
    let scores = { app:0, pul:0, gri:0, act:0, res:0 };
    function initApgarCalc() {
        const container = document.getElementById('apgar-calc');
        apgarData.forEach(item => {
            const row = document.createElement('div'); row.className = 'apgar-row';
            const label = document.createElement('div'); label.className = 'apgar-label'; label.innerText = item.label;
            const optsDiv = document.createElement('div'); optsDiv.className = 'apgar-options';
            item.opts.forEach((optText, idx) => {
                const btn = document.createElement('div'); btn.className = 'apgar-opt';
                if(idx === 0) btn.classList.add('selected');
                btn.innerText = optText;
                btn.onclick = () => {
                    scores[item.id] = idx;
                    optsDiv.querySelectorAll('.apgar-opt').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateTotalScore();
                };
                optsDiv.appendChild(btn);
            });
            row.appendChild(label); row.appendChild(optsDiv); container.appendChild(row);
        });
    }
    function updateTotalScore() {
        const total = scores.app + scores.pul + scores.gri + scores.act + scores.res;
        document.getElementById('totalScore').innerText = total;
    }
    function recordScore(min) {
        const score = document.getElementById('totalScore').innerText;
        document.getElementById(`rec-${min}min`).innerText = score + " åˆ†";
    }
    initApgarCalc();
</script>

</body>
</html>